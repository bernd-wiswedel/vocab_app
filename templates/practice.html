<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Üben</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="header">
        <div>
            <h1>{{ header }}</h1>
            <a href="{{ url_for('index') }}">Zurück</a>
        </div>
        {% if guest_mode %}
        <div class="guest-indicator">
            Gast-Modus (keine Speicherung)
        </div>
        {% endif %}
    </div>
    <div class="table-responsive">
        <table class="practice-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                    <th>{{ language }}</th>
                    {% if language == 'Latein' %}
                        <th>{{ col_name_comment }}</th>
                    {% endif %}
                    <th>{{ col_name_translation }}</th>
                    {% if language == 'Englisch' %}
                        <th>{{ col_name_comment }}</th>
                    {% endif %}
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for category, items in vocab_data.items() %}
                    <tr>
                        <td colspan="5" class="category-header">{{ category }}</td>
                    </tr>
                    {% for item in items %}
                        <tr>
                            <td><input type="checkbox" name="item-checkbox" value="{{ item[col_name_term] }}|{{ item[col_name_translation] }}|{{ language }}" onchange="updateTestButton()"></td>
                            <td>{{ item[col_name_term] }}</td>
                            {% if language == 'Latein' %}
                                <td>{{ item[col_name_comment] }}</td>
                            {% endif %}
                            <td>{{ item[col_name_translation] }}</td>
                            {% if language == 'Englisch' %}
                                <td>{{ item[col_name_comment] }}</td>
                            {% endif %}
                            <td>
                                {% if not guest_mode %}
                                    {% include '_status_display.html' %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="action-buttons">
        <form id="test-selected-form" action="/test_selected" method="post">
            <input type="hidden" name="selected-items" id="selected-items-input">
            <button type="submit" id="test-selected-button" disabled>Ausgewählte testen</button>
        </form>
    </div>

    <script>
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('input[name="item-checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateTestButton();
        }

        function updateTestButton() {
            const checkboxes = document.querySelectorAll('input[name="item-checkbox"]:checked');
            const button = document.getElementById('test-selected-button');
            button.disabled = checkboxes.length === 0;
        }

        function handleWriteScores(button) {
            // Disable the button to prevent multiple submissions
            button.disabled = true;

            // Change button text and add a spinning icon
            button.innerHTML = '<span class="spinner"></span> Speichern...';
        }

        // Set up form submission to include selected items
        document.getElementById('test-selected-form').addEventListener('submit', function(e) {
            const checkboxes = document.querySelectorAll('input[name="item-checkbox"]:checked');
            const selectedItems = Array.from(checkboxes).map(cb => cb.value);
            document.getElementById('selected-items-input').value = selectedItems.join('||');
        });
    </script>

    {% if is_error_review %}
    <div class="action-buttons" style="margin-top: 20px;">
        <form action="/test_errors" method="post">
            <button type="submit">Unvollständige neu testen</button>
        </form>
        <form action="/write_scores" method="post" onsubmit="handleWriteScores(this.querySelector('button'))">
            <button type="submit">Ergebnisse in Google Sheets speichern</button>
        </form>
    </div>
    {% endif %}
</body>
</html>
