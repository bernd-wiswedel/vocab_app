<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>√úben</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="header">
        <div>
            <h1>{{ header }}</h1>
            <a href="{{ url_for('index') }}">Zur√ºck</a>
        </div>
        {% if guest_mode %}
        <div class="guest-indicator">
            Gast-Modus (keine Speicherung)
        </div>
        {% endif %}
    </div>
    
    <div class="table-responsive">
        <table class="practice-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>{{ language }}</th>
                    {% if language == 'Latein' %}
                        <th>{{ col_name_comment }}</th>
                    {% endif %}
                    <th>{{ col_name_translation }}</th>
                    {% if language == 'Englisch' %}
                        <th>{{ col_name_comment }}</th>
                    {% endif %}
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for category, items in vocab_data.items() %}
                    <tr>
                        <td colspan="5" class="category-header">{{ category }}</td>
                    </tr>
                    {% for item in items %}
                        <tr class="item-row" data-row-index="{{ loop.index0 }}">
                            <td class="checkbox-cell"><input type="checkbox" name="item-checkbox" value="{{ item[col_name_term] }}|{{ item[col_name_translation] }}|{{ language }}"></td>
                            <td>{{ item[col_name_term] }}</td>
                            {% if language == 'Latein' %}
                                <td>{{ item[col_name_comment] }}</td>
                            {% endif %}
                            <td>{{ item[col_name_translation] }}</td>
                            {% if language == 'Englisch' %}
                                <td>{{ item[col_name_comment] }}</td>
                            {% endif %}
                            <td>
                                {% if guest_mode is defined and guest_mode %}
                                    -
                                {% else %}
                                    {% include '_status_display.html' %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="action-buttons">
        <button type="button" id="range-mode-btn" onclick="toggleRangeMode()" class="range-mode-button">
            üìè Bereichsauswahl
        </button>
        <div id="range-instruction" class="range-instruction" style="display:none">
            <span class="range-instruction-text">Tippe Start und Ende</span>
            <button type="button" onclick="exitRangeMode()" class="btn-small">Fertig</button>
        </div>
        <form id="test-selected-form" action="/test_selected" method="post">
            <input type="hidden" name="selected-items" id="selected-items-input">
            <button type="submit" id="test-selected-button" disabled>Ausgew√§hlte testen</button>
        </form>
    </div>

    <script>
        // ========================================
        // Vocabulary Practice Selection Module
        // ========================================
        (function() {
            'use strict';
            
            // ========================================
            // State Management
            // ========================================
            const state = {
                rangeMode: false,
                rangeStart: null,
                lastChecked: null
            };
            
            // ========================================
            // Constants
            // ========================================
            const SELECTORS = {
                checkbox: 'input[name="item-checkbox"]',
                selectAll: '#select-all',
                testButton: '#test-selected-button',
                rangeModeBtn: '#range-mode-btn',
                rangeInstruction: '#range-instruction',
                testForm: '#test-selected-form',
                selectedItemsInput: '#selected-items-input'
            };
            
            // ========================================
            // Utility Functions
            // ========================================
            
            function getAllCheckboxes() {
                return Array.from(document.querySelectorAll(SELECTORS.checkbox));
            }
            
            function getCheckedCheckboxes() {
                return document.querySelectorAll(SELECTORS.checkbox + ':checked');
            }
            
            function updateTestButton() {
                const button = document.querySelector(SELECTORS.testButton);
                button.disabled = getCheckedCheckboxes().length === 0;
            }
            
            function clearRangeMarkers() {
                document.querySelectorAll('.range-start').forEach(el => {
                    el.classList.remove('range-start');
                });
            }
            
            // ========================================
            // Range Selection Logic
            // ========================================
            
            function handleRangeSelection(checkbox) {
                const row = checkbox.closest('tr');
                
                if (!state.rangeStart) {
                    // First tap - mark range start
                    state.rangeStart = checkbox;
                    checkbox.checked = true;
                    row.classList.add('range-start');
                    updateTestButton();
                } else {
                    // Second tap - complete range selection
                    selectRangeBetween(state.rangeStart, checkbox);
                    
                    // Clean up range start marker
                    const startRow = state.rangeStart.closest('tr');
                    if (startRow) {
                        startRow.classList.remove('range-start');
                    }
                    state.rangeStart = null;
                }
            }
            
            function selectRangeBetween(start, end) {
                const checkboxes = getAllCheckboxes();
                const startIdx = checkboxes.indexOf(start);
                const endIdx = checkboxes.indexOf(end);
                
                if (startIdx === -1 || endIdx === -1) {
                    console.error('Checkbox not found in list', {startIdx, endIdx});
                    return;
                }
                
                const minIdx = Math.min(startIdx, endIdx);
                const maxIdx = Math.max(startIdx, endIdx);
                
                // Defer checkbox updates to avoid event handler conflicts
                requestAnimationFrame(() => {
                    for (let i = minIdx; i <= maxIdx; i++) {
                        checkboxes[i].checked = true;
                    }
                    state.lastChecked = end;
                    updateTestButton();
                });
            }
            
            // ========================================
            // Range Mode Controls
            // ========================================
            
            function toggleRangeMode() {
                state.rangeMode = !state.rangeMode;
                const btn = document.querySelector(SELECTORS.rangeModeBtn);
                const instruction = document.querySelector(SELECTORS.rangeInstruction);
                
                if (state.rangeMode) {
                    btn.classList.add('active');
                    instruction.style.display = 'flex';
                } else {
                    exitRangeMode();
                }
            }
            
            function exitRangeMode() {
                state.rangeMode = false;
                state.rangeStart = null;
                document.querySelector(SELECTORS.rangeModeBtn).classList.remove('active');
                document.querySelector(SELECTORS.rangeInstruction).style.display = 'none';
                clearRangeMarkers();
            }
            
            // ========================================
            // Checkbox Event Handlers
            // ========================================
            
            function handleCheckboxClick(event) {
                const checkbox = event.target;
                
                if (state.rangeMode) {
                    event.preventDefault();
                    handleRangeSelection(checkbox);
                } else if (event.shiftKey && state.lastChecked) {
                    event.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    selectRangeBetween(state.lastChecked, checkbox);
                } else {
                    state.lastChecked = checkbox;
                    requestAnimationFrame(updateTestButton);
                }
            }
            
            function handleSelectAll(event) {
                const selectAll = event.target;
                getAllCheckboxes().forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
                updateTestButton();
            }
            
            // ========================================
            // Form Submission
            // ========================================
            
            function handleFormSubmit(event) {
                const checkedCheckboxes = getCheckedCheckboxes();
                
                if (checkedCheckboxes.length === 0) {
                    event.preventDefault();
                    return;
                }
                
                const selectedItems = Array.from(checkedCheckboxes).map(cb => cb.value);
                document.querySelector(SELECTORS.selectedItemsInput).value = selectedItems.join('||');
            }
            
            // ========================================
            // Initialization
            // ========================================
            
            function init() {
                // Attach checkbox listeners
                getAllCheckboxes().forEach(checkbox => {
                    checkbox.addEventListener('click', handleCheckboxClick);
                });
                
                // Attach select-all listener
                const selectAll = document.querySelector(SELECTORS.selectAll);
                if (selectAll) {
                    selectAll.addEventListener('change', handleSelectAll);
                }
                
                // Attach form listener
                const form = document.querySelector(SELECTORS.testForm);
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
                
                // Initial button state
                updateTestButton();
            }
            
            // ========================================
            // Export to global scope (for inline handlers)
            // ========================================
            
            window.toggleRangeMode = toggleRangeMode;
            window.exitRangeMode = exitRangeMode;
            window.handleWriteScores = function(button) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span> Speichern...';
            };
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>

    {% if is_error_review %}
    <div class="action-buttons" style="margin-top: 20px;">
        <form action="/test_errors" method="post">
            <button type="submit">Unvollst√§ndige neu testen</button>
        </form>
        <form action="/write_scores" method="post" onsubmit="handleWriteScores(this.querySelector('button'))">
            <button type="submit">Ergebnisse in Google Sheets speichern</button>
        </form>
    </div>
    {% endif %}
</body>
</html>
